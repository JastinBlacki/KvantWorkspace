{% load static %}
{% load base_tags %}
{% load news_tags %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    
    {% include "SystemModule/HeadSetup/index.html" %}
    <link rel='stylesheet' href='{% static "SystemModule/icons/files/file-icons.css" %}'/>
    <link rel="stylesheet" href='{% static "NewsApp/MainPage/style.css" %}'> <!-- Стили страницы -->
    <link rel="stylesheet" href='{% static "SystemModule/text/highlight.css" %}'>
    <link rel="stylesheet" href='{% static "SystemModule/text/ql-editor.css" %}'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.9/dist/katex.min.css" integrity="sha384-r/BYDnh2ViiCwqZt5VJVWuADDic3NnnTIEOv4hOh05nSfB6tjWpKmn1kUHOVkMXc" crossorigin="anonymous"> <!-- Стили для отображения формул -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <title>Главная</title>
</head>

<body style="overflow: auto" onload="getNewNews();">
    <!-- Навигационное меню -->
    {% include "SystemModule/AsideMenu/index.html" with user=user active='main_page' %}
    <section id="main">
        
        <!-- ===== Виджеты ===== -->
        <section id='widgets'>

            <!-- Виджет "Календарь" -->
            <div id="calendar-widget">
                <div class="calendar-container">
                    <div class="date-info">
                        Июль 2021
                        <div id="slider-controller">
                            <button class='arrow'>
                                <svg viewBox="0 0 24 24"><path d="M10.88 17.715a1 1 0 000-1.415l-3.292-3.293L18 13a1 1 0 000-2l-10.414.007 3.294-3.292A1 1 0 009.466 6.3L5.88 9.886a3 3 0 000 4.243l3.586 3.586a1 1 0 001.414 0z"/></svg>
                            </button>
                            <button class='arrow'>
                                <svg viewBox="0 0 24 24"><path d="M13.121 6.293a1 1 0 000 1.414L16.413 11 6 11.007a1 1 0 100 2L16.414 13l-3.293 3.293a1 1 0 101.414 1.414l3.586-3.585a3 3 0 000-4.243l-3.586-3.586a1 1 0 00-1.414 0z"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="calendar">
                        <span class='inactive'>Пн</span><span class='inactive'>Вт</span><span class='inactive'>Ср</span><span class='inactive'>Чт</span><span class='inactive'>Пт</span><span class='inactive'>Сб</span><span class='inactive'>Вс</span>
                        <span class='inactive'>28</span><span class='inactive'>29</span><span class='inactive'>30</span><span>1</span><span>2</span><span>3</span><span>4</span>
                        <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span><span>11</span>
                        <span>12</span><span>13</span><span>14</span><span>15</span><span>16</span><span>17</span><span class='active'>18</span>
                        <span>19</span><span>20</span><span>21</span><span>22</span><span>23</span><span>24</span><span>25</span>
                        <span>26</span><span>27</span><span>28</span><span>29</span><span>30</span><span>31</span><span class='inactive'>1</span>
                    </div>
                </div>
                <div class="timetable">
                    <div class="event">
                        <span class="marker"></span>
                        <time>10:00</time>
                        <p class="event__name">День защиты детей</p>
                    </div>
                </div>
            </div>
            
            <!-- Виджет "Расписание" -->
            <div id="schedule-widget">
                <div class='widget-header'>
                    <!-- Заголовок виджета -->
                    <div>
                        <h1 style='display: inline-block; color: #000'>Расписание</h1>
                    </div>
                    <!-- Кнопки слайдера -->
                    <div id="slider-controller">
                        <button id='prev' class='arrow'>
                            <svg viewBox="0 0 24 24"><path d="M10.88 17.715a1 1 0 000-1.415l-3.292-3.293L18 13a1 1 0 000-2l-10.414.007 3.294-3.292A1 1 0 009.466 6.3L5.88 9.886a3 3 0 000 4.243l3.586 3.586a1 1 0 001.414 0z"/></svg>
                        </button>
                        <button id='next' class='arrow'>
                            <svg viewBox="0 0 24 24"><path d="M13.121 6.293a1 1 0 000 1.414L16.413 11 6 11.007a1 1 0 100 2L16.414 13l-3.293 3.293a1 1 0 101.414 1.414l3.586-3.585a3 3 0 000-4.243l-3.586-3.586a1 1 0 00-1.414 0z"/></svg>
                        </button>
                    </div>
                </div>
                <div id='slider'>
                    {% for course in courses %}
                    <div class='item course'>
                        <img src="{% static 'NewsApp/MainPage/imgs/courseImg.jpg' %}" class='course__banner'/>
                        <img src="{{ course.teacher.teacher.image.url }}" class='teacherProfileImg'/>
                        <div class="course__info">
                            <h2>{{ course.name }}</h2>
                            <h4>{{ course.teacher.teacher.surname }} {{ course.teacher.teacher.name|slice:"1" }}.</h4>
                        </div>
                        <div class="course__timetable">
                            <div class="lessonDay">
                                <div class="weekday">Вт</div>
                                <time>18:20</time>
                            </div>
                            <div class="lessonDay">
                                <div class="weekday">Чт</div>
                                <time>18:20</time>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Форма просмотра курса -->
            {% for course in courses %}
            <div class='form' style='padding: 0'>
                <div class="form-wrapper">
                    <form>
                        <div class='item-header'>
                            <div class='lesson-title'>
                                <h2>{{ course.name }}</h2>
                            </div>
                            <div class='lesson-teacher'>
                                <h4>{{ course.teacher.teacher.surname }}
                                    {{ course.teacher.teacher.name }}
                                    {{ course.teacher.teacher.patronymic }}
                                </h4>
                                <img src='{{ course.teacher.teacher.image.url }}' />
                            </div>
                        </div>
                        <p class='item-text'>Описание направления</p>
                        <hr class='divider'/>
                        <h2>Расписание</h2>
                        <div class="calendar__timetable">
                            <div class="day">Пн</div>
                            <div class="day active">Вт<time>18:20</time></div>
                            <div class="day">Ср</div>
                            <div class="day active">Чт<time>18:20</time></div>
                            <div class="day">Пт</div>
                            <div class="day">Сб</div>
                            <div class="day">Вс</div>
                        </div>
                        <hr class="divider"/>
                        <h2>Участники курса</h2>
                        <div class="users">
                            {% for student in course.students|get_objects %}
                            <div class="user">
                                <img src='{{ student.student.image.url }}'/>
                                <div class="info">
                                    <h4>{{ student.student.permission }}</h4>
                                    <h2>{{ student.student.name }} {{ student.student.surname }}</h2>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </section>
        
        <!-- ===== Новости ===== -->
        <section id='news'>
            <!-- Шапка секции -->
            <div style='display: flex; gap: 2%'>
                <!-- Заголовок секции -->
                <div>
                    <h1 style='display: inline-block'>Новости</h1>
                </div>
                <div class='main-btn' style='width: auto'>
                    <button style='height: 40px;' onclick="open_form('#news-form')">Добавить новость</button>
                </div>
            </div>
            <!-- Блок новостей -->
            <div id='news__container'>
                <!-- Спавн новсотей -->
            </div>
            <!-- Кнопка "Больше новостей" -->
            <div class='main-btn'>
                <button onclick="getNewNews()" id="more-news">Больше новостей</button>
            </div>
            {% include "NewsApp/NewsCreationForm/index.html" with form_status="create" %}
        </section>
    </section>
    <div class="alertsContainer column" id='alertsContainer'></div>
    {% include "SystemModule/ScriptsSetup/index.html" with user=user %}
    <script src="{% static 'NewsApp/MainPage/scripts.js' %}"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="{% static 'NewsApp/Core/scripts.js' %}"></script>
    <script>AOS.init({ offset: -9999999 })</script>
    <!-- Функционал слайдера -->
    <script>
        $(document).ready(function () {
            $('#next').click(function () {
                $('#slider').animate({ scrollLeft: $('#slider').scrollLeft() + 750 }, 400);
            });
            $('#prev').click(function () {
                $('#slider').animate({ scrollLeft: $('#slider').scrollLeft() - 750 }, 400);
            });
        });
    </script>
    <!-- Функция получения новостей -->
    <script>
        const all_news = {{ max_news }};
        const news_per_page_num = 6;
        // Запрос новостей с сервера
        function getNewNews(){
            $.ajax({
                type: 'GET',
                url: `{% url "send_news" user.id %}?page=${page}`,
                cache: false,
                success: function(response){
                    $('#news__container').append(response);
                    if(page * news_per_page_num >= all_news){  // Проверка наличия еще страниц пагинации
                        $('#more-news')[0].style.display = 'none';
                    }
                    page++
                }
            })
        }
    </script>
    <script>
        // Отправка формы новости на сервер
        $('#news-upload').on('click', () => sendOrUpdateNews(getNewsFormData()));
    </script>
</body>
</html>